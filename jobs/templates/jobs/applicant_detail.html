<!-- jobs/templates/jobs/applicant_detail.html -->
{% extends 'base.html' %}

{% block title %}Applicant Details - {{ application.candidate_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">{{ application.candidate_name }}</h1>
            <p class="text-muted mb-0">Applied for {{ application.job.title }} at {{ application.job.company }}</p>
            <p class="text-muted">Applied on {{ application.applied_at|date:"F j, Y" }}</p>
        </div>
        <div>
            <a href="{% url 'job_pipeline' application.job.pk %}" class="btn btn-outline-secondary">
                <i class="fas fa-columns"></i> Back to Pipeline
            </a>
            <a href="{% url 'send_message_to_candidate' application.id %}" class="btn btn-primary">
                <i class="fas fa-envelope"></i> Send Message
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Application Details -->
        <div class="col-lg-8">
            <!-- Current Status Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tachometer-alt me-2"></i>Current Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Current Stage:</strong>
                            {% if application.current_pipeline_stage %}
                            <span class="badge pipeline-stage-badge ms-2" data-stage-color="{{ application.current_pipeline_stage.color }}">
                                {{ application.current_pipeline_stage.name }}
                            </span>
                            {% else %}
                            <span class="text-muted">Not in pipeline</span>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Application Status:</strong>
                            <span class="badge bg-secondary ms-2">{{ application.get_status_display }}</span>
                        </div>
                    </div>
                    
                    <!-- Move to Stage Form (AJAX) -->
                    <div class="move-stage-form">
                        <div class="row align-items-end">
                            <div class="col-md-8">
                                <label class="form-label"><strong>Move to Stage:</strong></label>
                                <select name="new_stage_id" class="form-select stage-select" 
                                        data-applicant-id="{{ application.id }}"
                                        data-current-stage="{{ application.current_pipeline_stage.id }}">
                                    {% for stage in application.job.pipeline_stages.all %}
                                    <option value="{{ stage.id }}" {% if application.current_pipeline_stage.id == stage.id %}selected{% endif %}>
                                        {{ stage.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-primary w-100 move-stage-btn">
                                    <i class="fas fa-arrow-right me-1"></i> Move
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Application Details Card -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-alt me-2"></i>Application Details
                    </h5>
                </div>
                <div class="card-body">
                    <h6 class="mb-3">Why are you interested in this position?</h6>
                    <div class="bg-light p-3 rounded mb-4">
                        {{ application.application_note|linebreaks }}
                    </div>
                    
                    {% if application.resume %}
                    <div class="mt-3">
                        <strong>Resume:</strong>
                        <a href="{{ application.resume.url }}" target="_blank" class="btn btn-outline-primary btn-sm ms-2">
                            <i class="fas fa-download me-1"></i> Download Resume
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Skills & Qualifications -->
            {% if applicant_profile and applicant_profile.skills %}
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-star me-2"></i>Skills & Qualifications
                    </h5>
                </div>
                <div class="card-body">
                    <h6 class="mb-3">Skills:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        {% for skill in applicant_profile.skills.split %}
                        <span class="badge bg-secondary">{{ skill.strip }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Job Requirements -->
            {% if application.job.requirements %}
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-briefcase me-2"></i>Job Requirements
                    </h5>
                </div>
                <div class="card-body">
                    <div class="bg-light p-3 rounded">
                        {{ application.job.requirements|linebreaks }}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Profile & Contact -->
        <div class="col-lg-4">
            <!-- Contact Information Card -->
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user me-2"></i>Candidate Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong><i class="fas fa-user me-2"></i>Full Name:</strong>
                        <p class="mb-0 mt-1">{{ application.candidate_name }}</p>
                    </div>
                    
                    <div class="mb-3">
                        <strong><i class="fas fa-envelope me-2"></i>Email:</strong>
                        <p class="mb-0 mt-1">
                            {% if application.candidate_email %}
                            <a href="mailto:{{ application.candidate_email }}">{{ application.candidate_email }}</a>
                            {% else %}
                            <span class="text-muted">No email available</span>
                            {% endif %}
                        </p>
                    </div>
                    
                    {% if applicant_profile %}
                    <div class="mb-3">
                        <strong><i class="fas fa-phone me-2"></i>Phone:</strong>
                        <p class="mb-0 mt-1">
                            {% if applicant_profile.phone %}
                            <a href="tel:{{ applicant_profile.phone }}">{{ applicant_profile.phone }}</a>
                            {% else %}
                            <span class="text-muted">Not provided</span>
                            {% endif %}
                        </p>
                    </div>
                    
                    <div class="mb-3">
                        <strong><i class="fas fa-map-marker-alt me-2"></i>Location:</strong>
                        <p class="mb-0 mt-1">
                            {% if applicant_profile.location %}
                            {{ applicant_profile.location }}
                            {% else %}
                            <span class="text-muted">Not provided</span>
                            {% endif %}
                        </p>
                    </div>
                    
                    <div class="mb-3">
                        <strong><i class="fas fa-link me-2"></i>LinkedIn/Portfolio:</strong>
                        <p class="mb-0 mt-1">
                            {% if applicant_profile.linkedin_url %}
                            <a href="{{ applicant_profile.linkedin_url }}" target="_blank">{{ applicant_profile.linkedin_url }}</a>
                            {% else %}
                            <span class="text-muted">Not provided</span>
                            {% endif %}
                        </p>
                    </div>
                    {% endif %}
                    
                    <div class="mt-4">
                        <a href="mailto:{{ application.candidate_email|default:'' }}" 
                           class="btn btn-primary w-100 mb-2 {% if not application.candidate_email %}disabled{% endif %}">
                            <i class="fas fa-envelope me-1"></i> Send Email
                        </a>
                        <a href="{% url 'send_message_to_candidate' application.id %}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-comment me-1"></i> Send Internal Message
                        </a>
                    </div>
                </div>
            </div>

            <!-- Profile Summary -->
            {% if applicant_profile and applicant_profile.bio %}
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-invoice me-2"></i>Profile Summary
                    </h5>
                </div>
                <div class="card-body">
                    <p>{{ applicant_profile.bio|linebreaks }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Internal Notes -->
            {% if application.pipeline_info.notes %}
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-sticky-note me-2"></i>Internal Notes
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ application.pipeline_info.notes }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Stage History -->
            {% if stage_history %}
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>Stage History
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% for transition in stage_history %}
                        <div class="timeline-item mb-3">
                            <div class="timeline-content">
                                <strong>{{ transition.to_stage.name }}</strong>
                                <small class="text-muted d-block">
                                    {{ transition.moved_at|date:"M j, Y g:i A" }}
                                </small>
                                {% if transition.moved_by %}
                                <small class="text-muted">by {{ transition.moved_by.get_full_name|default:transition.moved_by.username }}</small>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
.timeline {
    position: relative;
    padding-left: 20px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 2px;
    background-color: #dee2e6;
}

.timeline-item {
    position: relative;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -24px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #6c757d;
    border: 2px solid white;
}

.pipeline-stage-badge {
    color: white !important;
    font-weight: 500;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Apply stage badge colors
    document.querySelectorAll('.pipeline-stage-badge').forEach(badge => {
        const color = badge.dataset.stageColor;
        if (color) {
            badge.style.backgroundColor = color;
        }
    });

    // Handle stage movement form
    const moveStageBtn = document.querySelector('.move-stage-btn');
    const stageSelect = document.querySelector('.stage-select');
    
    if (moveStageBtn && stageSelect) {
        moveStageBtn.addEventListener('click', function() {
            const applicantId = stageSelect.dataset.applicantId;
            const newStageId = stageSelect.value;
            const currentStageId = stageSelect.dataset.currentStage;
            
            if (!newStageId || newStageId === currentStageId) {
                showAlert('Please select a different stage to move the applicant.', 'warning');
                return;
            }
            
            moveApplicant(applicantId, newStageId, stageSelect, moveStageBtn);
        });
    }
    
    function moveApplicant(applicantId, newStageId, selectElement, buttonElement) {
        // Show loading state
        const originalText = buttonElement.innerHTML;
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Moving...';
        buttonElement.disabled = true;
        
        const moveUrl = "{% url 'move_applicant' 0 %}".replace('0', applicantId);
        
        fetch(moveUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'new_stage_id=' + newStageId
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showAlert('✅ Applicant moved to ' + data.new_stage_name, 'success');
                
                // Reload the page after a short delay to show updated information
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showAlert('❌ Error: ' + data.message, 'error');
                buttonElement.innerHTML = originalText;
                buttonElement.disabled = false;
            }
        })
        .catch(error => {
            showAlert('❌ Network error: ' + error.message, 'error');
            buttonElement.innerHTML = originalText;
            buttonElement.disabled = false;
        });
    }
    
    function showAlert(message, type) {
        // Remove any existing alerts
        const existingAlerts = document.querySelectorAll('.applicant-alert');
        existingAlerts.forEach(alert => alert.remove());
        
        // Create new alert
        const alertDiv = document.createElement('div');
        alertDiv.className = 'applicant-alert alert alert-' + (type === 'error' ? 'danger' : (type === 'warning' ? 'warning' : 'success')) + ' alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
        alertDiv.style.zIndex = '1050';
        alertDiv.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        document.body.appendChild(alertDiv);
        
        // Auto-hide after 5 seconds for success, 8 seconds for errors
        const hideTime = type === 'success' ? 5000 : 8000;
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, hideTime);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}