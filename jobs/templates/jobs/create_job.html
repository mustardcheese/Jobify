{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h2 class="navy-text mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        {{ title|default:"Create Job" }}
                    </h2>
                    <p class="text-muted mb-0">
                        Pin your job location on the map for better candidate visibility
                    </p>
                </div>

                <div class="card-body">
                    <form method="post" id="job-form">
                        {% csrf_token %}

                        <!-- Row: title / company -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.title.label_tag }}
                                    {{ form.title }}
                                    {% if form.title.errors %}
                                    <div class="text-danger">{{ form.title.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.company.label_tag }}
                                    {{ form.company }}
                                    {% if form.company.errors %}
                                    <div class="text-danger">{{ form.company.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Row: job_type / experience_level -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.job_type.label_tag }}
                                    {{ form.job_type }}
                                    {% if form.job_type.errors %}
                                    <div class="text-danger">{{ form.job_type.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.experience_level.label_tag }}
                                    {{ form.experience_level }}
                                    {% if form.experience_level.errors %}
                                    <div class="text-danger">{{ form.experience_level.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Salary -->
                        <div class="mb-3">
                            {{ form.salary_range.label_tag }}
                            {{ form.salary_range }}
                            {% if form.salary_range.errors %}
                            <div class="text-danger">{{ form.salary_range.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Location + "Find on Map" -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                {{ form.location.label }}
                            </label>

                            <div class="input-group">
                                {{ form.location }}

                                <button type="button" class="btn btn-outline-secondary" id="geocode-btn">
                                    <i class="fas fa-search-location"></i>
                                    Find on Map
                                </button>
                            </div>

                            {% if form.location.errors %}
                            <div class="text-danger">{{ form.location.errors }}</div>
                            {% endif %}

                            <small class="form-text text-muted">
                                Enter a full address (e.g. "123 Main St, San Francisco, CA") for best results
                            </small>
                        </div>

                        <!-- Map preview -->
                        <div class="mb-4" id="map-section" style="display: none;">
                            <label class="form-label">Location Preview</label>
                            <div id="location-map"
                                style="height: 300px; border-radius: 8px; border: 1px solid #dee2e6;">
                            </div>
                            <div id="location-info" class="mt-2 text-muted"></div>
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            {{ form.description.label_tag }}
                            {{ form.description }}
                            {% if form.description.errors %}
                            <div class="text-danger">{{ form.description.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Requirements -->
                        <div class="mb-3">
                            {{ form.requirements.label_tag }}
                            {{ form.requirements }}
                            {% if form.requirements.errors %}
                            <div class="text-danger">{{ form.requirements.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Active? -->
                        <div class="mb-3 form-check">
                            {{ form.is_active }}
                            <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                {{ form.is_active.label }}
                            </label>
                            {% if form.is_active.errors %}
                            <div class="text-danger">{{ form.is_active.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Footer buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'recruiter_dashboard' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>
                                Back to Dashboard
                            </a>

                            <button type="submit" class="btn navy-bg eggshell-text">
                                <i class="fas fa-save me-1"></i>
                                {% if job %}Update Job{% else %}Create Job{% endif %}
                            </button>
                        </div>
                    </form>
                </div> <!-- card-body -->
            </div> <!-- card -->
        </div> <!-- col -->
    </div> <!-- row -->
</div> <!-- container -->

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Django data injection - render outside of JavaScript -->
<script id="django-data" type="application/json">
{
    "geocode_url": "{% url 'geocode_ajax' %}",
    "existing_lat": {% if job.latitude %}{{ job.latitude }}{% else %}null{% endif %},
    "existing_lng": {% if job.longitude %}{{ job.longitude }}{% else %}null{% endif %},
    "existing_location": {% if job.location %}"{{ job.location|escapejs }}"{% else %}""{% endif %}
}
</script>

<script>
    let map;
    let marker;
    let currentLocation = null;

    // Load Django data from JSON script tag
    const djangoData = JSON.parse(document.getElementById('django-data').textContent);

    // helper: get CSRF token from the form so we can POST fetch() to /api/geocode
    function getCSRFToken() {
        const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
        return tokenInput ? tokenInput.value : '';
    }

    document.addEventListener('DOMContentLoaded', function () {
        const mapEl = document.getElementById('location-map');
        const mapSectionEl = document.getElementById('map-section');
        const locationInfoEl = document.getElementById('location-info');
        const locationInput = document.getElementById('location-input'); // id provided by the form widget
        const geocodeBtn = document.getElementById('geocode-btn');
        const formEl = document.getElementById('job-form');

        // 1. init leaflet map only when needed (lazy initialization)
        function initMap() {
            if (!map) {
                map = L.map('location-map').setView([37.7749, -122.4194], 10);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: 'Â© OpenStreetMap'
                }).addTo(map);
            }
        }

        // helper to drop marker + show section
        function showLocationOnMap(lat, lng, displayName) {
            currentLocation = { lat: lat, lng: lng, name: displayName };

            // Show map section first
            mapSectionEl.style.display = 'block';

            // Initialize map if not already done
            initMap();

            // Give the browser time to render the visible container
            setTimeout(function () {
                // Invalidate size to recalculate dimensions
                map.invalidateSize();

                // Set view and add marker
                map.setView([lat, lng], 13);

                if (marker) {
                    map.removeLayer(marker);
                }

                marker = L.marker([lat, lng]).addTo(map);
                marker.bindPopup('<b>Job Location</b><br>' + displayName).openPopup();
            }, 100);

            locationInfoEl.innerHTML =
                '<i class="fas fa-check-circle text-success me-1"></i>' +
                'Location found: ' + displayName;
        }

        // 2. "Find on Map" click handler
        if (geocodeBtn && locationInput) {
            geocodeBtn.addEventListener('click', function () {
                const locationVal = locationInput.value.trim();
                if (!locationVal) {
                    alert('Please enter a location first');
                    return;
                }

                geocodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Finding...';
                geocodeBtn.disabled = true;

                fetch(djangoData.geocode_url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(),
                    },
                    body: JSON.stringify({ location: locationVal })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showLocationOnMap(data.latitude, data.longitude, data.display_name);
                        } else {
                            alert('Location not found. Please try a more specific address.');
                        }
                    })
                    .catch(err => {
                        console.error('Error:', err);
                        alert('Error finding location. Please try again.');
                    })
                    .finally(() => {
                        geocodeBtn.innerHTML = '<i class="fas fa-search-location"></i> Find on Map';
                        geocodeBtn.disabled = false;
                    });
            });
        }

        // 3. If this template is ALSO used for editing,
        //    and the view passed a `job` with lat/lng, preload map.
        if (djangoData.existing_lat !== null && djangoData.existing_lng !== null && djangoData.existing_location) {
            showLocationOnMap(djangoData.existing_lat, djangoData.existing_lng, djangoData.existing_location);
        }

        // 4. Before submit: inject hidden lat/lng fields if we found a map location
        if (formEl) {
            formEl.addEventListener('submit', function () {
                if (currentLocation) {
                    const latInput = document.createElement('input');
                    latInput.type = 'hidden';
                    latInput.name = 'latitude';
                    latInput.value = currentLocation.lat;

                    const lngInput = document.createElement('input');
                    lngInput.type = 'hidden';
                    lngInput.name = 'longitude';
                    lngInput.value = currentLocation.lng;

                    formEl.appendChild(latInput);
                    formEl.appendChild(lngInput);
                }
            });
        }
    });
</script>

<style>
    #location-map {
        border: 2px solid #e9ecef;
        border-radius: 8px;
    }

    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .navy-bg {
        background-color: #1e3a8a;
        border-color: #1e3a8a;
    }

    .navy-bg:hover {
        background-color: #1e40af;
        border-color: #1e40af;
    }

    .navy-text {
        color: #1e3a8a;
    }

    .eggshell-text {
        color: #f8f9fa;
    }
</style>
{% endblock content %}